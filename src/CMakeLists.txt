# SPDX-FileCopyrightText: Copyright (c) 2025 MBition GmbH.
# SPDX-License-Identifier: GPL-2.0-or-later

# autogenerated code is is excluded as a seperate target to specifiy different compiler flags
add_library(
    kwin4_effect_arhud_protocol STATIC
)

ecm_add_qtwayland_server_protocol(kwin4_effect_arhud_protocol
    PROTOCOL ${MBITION_WAYLAND_PROTOCOLS_DIR}/mbition-mini-hud-warping-unstable-v1.xml
    BASENAME mbition-mini-hud-warping-unstable-v1
)

ecm_add_qtwayland_server_protocol(kwin4_effect_arhud_protocol
    PROTOCOL ${MBITION_WAYLAND_PROTOCOLS_DIR}/mbition-warped-output-unstable-v1.xml
    BASENAME mbition-warped-output-unstable-v1
)

target_link_libraries(kwin4_effect_arhud_protocol PRIVATE
    Qt::Core
    Wayland::Server
)

# actual library target
add_library(kwin4_effect_arhud
    classicArHud.cpp
    classicArHud.h
    main.cpp
    defaultHud.cpp
    defaultHud.h
    warpingEffect.h
    warpingEffect.cpp
    shaders.qrc
)

add_subdirectory(arhud-matrix)
add_subdirectory(wayland)

target_include_directories(kwin4_effect_arhud PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/arhud-matrix")
target_include_directories(kwin4_effect_arhud PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/wayland")

ecm_qt_declare_logging_category(kwin4_effect_arhud
    HEADER kwinarhud_debug.h
    IDENTIFIER KWINARHUD_DEBUG
    CATEGORY_NAME io.mbition.kwinarhud
)

target_link_libraries(kwin4_effect_arhud PRIVATE
    Qt::Core
    Qt::Gui
    KWin::kwin
    Wayland::Server
    kwin4_effect_arhud_protocol
)

install(
    TARGETS
        kwin4_effect_arhud

    DESTINATION
        ${KDE_INSTALL_PLUGINDIR}/kwin/effects/plugins/
)

list(REMOVE_ITEM SECURE_CXX_COMPILATION_FLAGS -Wstrict-overflow) # fails in qmetatype.h
list(REMOVE_ITEM SECURE_CXX_COMPILATION_FLAGS -Werror=sign-conversion) # fails in qarraydata.h
list(REMOVE_ITEM SECURE_CXX_COMPILATION_FLAGS -Werror=conversion) # fails in qfloat16.h, qmatrix4x4.h

activate_secure_compilation(kwin4_effect_arhud)
message(STATUS "Compiler flags for kwin4_effect_arhud: ${SECURE_CXX_COMPILATION_FLAGS}")

activate_pedantic_compilation(kwin4_effect_arhud_protocol)
message(STATUS "Compiler flags for kwin4_effect_arhud_protocol: ${SECURE_CXX_COMPILATION_FLAGS}")
